<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css" type="text/css">
    <title>Grazhdane Chat</title>
</head>
<body>
    <h1 id="hello">–ß–∞—Ç—Ç–∏–∫</h1>
    
    <div id="authSection">
        <div class="auth-form">
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <input type="text" id="regUsername" placeholder="Username">
            <input type="password" id="regPassword" placeholder="Password">
            <button id="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </div>
        
        <div class="auth-form">
            <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
            <input type="text" id="loginUsername" placeholder="Username">
            <input type="password" id="loginPassword" placeholder="Password">
            <button id="loginBtn">–í–æ–π—Ç–∏</button>
        </div>
    </div>
    
    <div id="chatSection" class="hidden">
        <div id="messages"></div>
        <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="sendButton">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <div id="themeToggle" class="theme-toggle">
        <span class="theme-icon">üåì</span>
    </div>

    <script>
        // Turning on theme toggler as soon as the page loads
        initTheme();

        let token = '';
        let ws = null;
        
        // DOM elements
        const authSection = document.getElementById('authSection');
        const chatSection = document.getElementById('chatSection');
        const messages = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        
        // Api func
        async function register() {
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            
            const response = await fetch('/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password }),
            });
            
            if (response.ok) {
                alert('Registration successful! Please login.');
            } else {
                alert('Registration failed: ' + (await response.text()));
            }
        }
        
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const response = await fetch('/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password }),
            });
            
            if (response.ok) {
                const data = await response.json();
                token = data.token;
                
                authSection.classList.add('hidden');
                chatSection.classList.remove('hidden');
                
                connectWebSocket();

                loadMessageHistory();
            } else {
                alert('Login failed: ' + (await response.text()));
            }
        }
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const wsUrl = protocol + window.location.host + '/ws';
            
            console.log('Connecting to WebSocket:', wsUrl);
            ws = new WebSocket(wsUrl);

            // Reconnection timeout
            const reconnectTimeout = 3000;

            ws.onopen = function() {
                console.log('WebSocket connected');
                const token = localStorage.getItem('token');
                if (token) {
                    console.log(token);
                }
            };

            ws.onmessage = function(event) {
                try {
                    const msg = JSON.parse(event.data);
                    const isCurrentUser = msg.username === document.getElementById('loginUsername').value;
                    
                    const messageElement = document.createElement('div');
                    messageElement.className = isCurrentUser 
                        ? 'message my-message' 
                        : 'message other-message';
                    
                    messageElement.innerHTML = `
                        <strong>${isCurrentUser ? '–í—ã' : msg.username}</strong>
                        <div class="text">${msg.text}</div>
                        <span class="time">${new Date().toLocaleTimeString()}</span>
                    `;
                    
                    document.getElementById('messages').appendChild(messageElement);
                } catch (e) {
                    console.error('Error parsing message:', e);
                }
            }

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                setTimeout(connectWebSocket, reconnectTimeout);
            };

            ws.onclose = function(event) {
                console.log(`WebSocket closed: ${event.code} ${event.reason}`);
                if (event.code === 1006) {
                    setTimeout(connectWebSocket, reconnectTimeout);
                }
            };
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !ws || ws.readyState !== WebSocket.OPEN) {
                console.log('Cannot send message:', {text, wsReady: ws?.readyState});
                return;
            }
            
            try {
                ws.send(text); 
                messageInput.value = '';
            } catch (e) {
                console.error('Error sending message:', e);
            }
        }

        async function loadMessageHistory() {
            try {
                const currentUsername = document.getElementById('loginUsername').value;
                const response = await fetch('/messages', {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    }
                });
                
                const messages = await response.json();
                const messagesContainer = document.getElementById('messages');
                messagesContainer.innerHTML = '';
                
                messages.forEach(msg => {
                    const isCurrentUser = msg.username === currentUsername;
                    
                    const messageElement = document.createElement('div');
                    messageElement.className = isCurrentUser 
                        ? 'message my-message' 
                        : 'message other-message';
                    
                    messageElement.innerHTML = `
                        <strong>${isCurrentUser ? '–í—ã' : msg.username}</strong>
                        <div class="text">${msg.text}</div>
                        <span class="time">${formatTime(msg.time)}</span>
                    `;
                    
                    messagesContainer.appendChild(messageElement);
                });
                
                // Scrolling down after logging in
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Additional func for formatting timestamps
        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function addMessageToChat(msg) {
            const messageElement = document.createElement('div');
            const isCurrentUser = msg.username === document.getElementById('loginUsername').value;
            
            messageElement.className = isCurrentUser ? 'message my-message' : 'message other-message';
            messageElement.innerHTML = `
                <strong>${isCurrentUser ? '–í—ã' : msg.username}</strong>
                <div class="text">${msg.text}</div>
                <span class="time">${new Date(msg.time).toLocaleTimeString()}</span>
            `;
            
            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;
        }
                
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Icon switch
            document.querySelector('.theme-icon').textContent = newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }

        // Theme initialization
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.querySelector('.theme-icon').textContent = savedTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        }

        // Authentication handlers
        document.getElementById('registerBtn').addEventListener('click', register);
        document.getElementById('loginBtn').addEventListener('click', login);
        
        // Sending messages by pressing ENTER
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Theme Toggler
        document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    </script>
</body>
</html>